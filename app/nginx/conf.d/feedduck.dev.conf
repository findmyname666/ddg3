# Upstream backend - FeedDuck web application
upstream feedduck_backend {
    server web:8080;
    keepalive 32;
}

# Rate limiting - 1 requests per second per IP
limit_req_zone $binary_remote_addr zone=ratelimit:10m rate=1r/s;

# HTTPS server - development mode with self-signed certificates
server {
    # HTTPS listeners
    listen 443 ssl;
    listen [::]:443 ssl;

    # HTTP/3 over QUIC (UDP)
    listen 443 quic reuseport;
    listen [::]:443 quic reuseport;

    server_name localhost feedduck.local;

    # Enable HTTP/2 and HTTP/3
    http2 on;

    # Advertise HTTP/3 support via Alt-Svc header
    add_header Alt-Svc 'h3=":443"; ma=86400' always;

    # SSL certificates (self-signed for dev)
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Session cache (shared between HTTP/2 and HTTP/3)
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Enable early data for 0-RTT (optional, improves performance)
    ssl_early_data on;

    # QUIC-specific settings
    quic_retry on;  # Enable address validation

    # Health check endpoint
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Proxy to backend
    location / {
        # Apply rate limiting (1 req/sec, burst of 5, delay excess requests)
        limit_req zone=ratelimit burst=5 delay=3;

        proxy_pass http://feedduck_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # Static files caching
    location /static/ {
        # Apply rate limiting (1 req/sec, burst of 5, delay excess requests)
        limit_req zone=ratelimit burst=5 delay=3;

        proxy_pass http://feedduck_backend;
        proxy_http_version 1.1;

        # Cache static files
        proxy_cache_valid 200 1h;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Browser caching
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
}
